(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=global||self,global.Camera=factory())})(this,function(){class Camera{constructor(video,options){let defalultOptions={audio:false,video:{frameRate:{ideal:100,max:150}}};this.opts={...defalultOptions,...options};this.isOpen=false;this.isOpenLoading=false;this.video=video;this.isPhone=(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))}open(deviceId){return new Promise(async(resolve,reject)=>{if(!this.isVideo(this.video)){this.isOpen=false;this.isOpenLoading=false;let errMsg="video not HTMLElement";reject({errMsg})}else{this.isOpenLoading=true;this.isOpen=false;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){await this.getMediaDevices();let mediaOpts={audio:this.opts.audio,video:this.opts.video,};if(deviceId==="user"||deviceId==="environment"){mediaOpts.video.facingMode=deviceId}else if(deviceId){mediaOpts.video.deviceId=deviceId}else{mediaOpts.video.facingMode="user"}navigator.mediaDevices.getUserMedia(mediaOpts).then(stream=>{const VideoTracks=stream.getVideoTracks()if(VideoTracks.length>0){this.stream=stream;this.video.pause();this.video.setAttribute("playsinline",true);if("srcObject"in this.video){this.video.srcObject=stream}else{this.video.src=stream};this.video.onloadedmetadata=async()=>{await this.video.play();this.isOpen=true;this.isOpenLoading=false;let tracks=VideoTracks[0];tracks.constraints=tracks.getConstraints();tracks.settings=tracks.getSettings();if(this.isPhone){if(tracks.settings&&tracks.settings.deviceId){tracks.settings.deviceId=deviceId}}console.log(tracks);this.tracks=tracks;resolve(this.tracks)};this.video.onError=(err)=>{const error={errMsg:'video Error-'+err,opts:this.opts};reject(error)}}else{const error={errMsg:'No VideoTracks',opts:this.opts};reject(error)}}).catch(err=>{const error={errMsg:'Failed to acquire camera feed: '+err,opts:this.opts};reject(error)})}else{const error={errMsg:'No navigator.mediaDevices.getUserMedia exists',opts:this.opts};reject(error)}}})}stop(){return new Promise((resolve)=>{this.isOpen&&this.stream&&this.stream.getVideoTracks().forEach(async track=>{await track.stop()})resolve(this)})}getMediaDevices(){return new Promise((resolve,reject)=>{if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){if(this.isPhone){resolve([{label:"前置摄像头",deviceId:"user"},{label:"后置摄像头",deviceId:"environment"}])}else{navigator.mediaDevices.enumerateDevices().then(devices=>{const devicesList=(devices||[]).filter(e=>e.kind==="videoinput"&&e.deviceId);this.devicesList=devicesList;resolve(devicesList)})}}else{const error={errMsg:'No navigator.mediaDevices.enumerateDevices exists',opts:this.opts};reject(error)}})}isVideo(obj){return obj instanceof HTMLElement&&obj.nodeName==="VIDEO"}};return Camera})