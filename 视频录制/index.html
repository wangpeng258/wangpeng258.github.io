<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>å½•åˆ¶è§†é¢‘</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="" type="image/x-icon" />
    <meta name="format-detection" content="telephone=no">
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.9/theme-chalk/index.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.7.4/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue-resource/1.5.3/vue-resource.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.9/index.min.js"></script>
    <script src="https://mrdoob.github.io/stats.js/build/stats.min.js"></script>
    <script src="jsQR.js"></script>
    <script src="videoMonitor.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        html {
            overflow-y: scroll;
        }

        :root {
            overflow-y: auto;
            overflow-x: hidden;
        }

        :root body {
            position: absolute;
        }

        body {
            width: 100vw;
            overflow: hidden;
        }
        ::-webkit-scrollbar {
            height: 18px;
            width: 18px;
        }

        ::-webkit-scrollbar-button,
        ::-webkit-scrollbar-corner {
            background: transparent;
            cursor: pointer;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 9px;
            border: solid 6px transparent;
            background-color: #c8c6c4;
            background-clip: content-box;
            cursor: pointer;
            transition: all 0.4s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #383838;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-button:horizontal:increment {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEXM09b///8OmaLeAAAAAnRSTlP/AOW3MEoAAAAgSURBVHgBY2BEA+QLMGAIMGAIMGAIMBAUIGQoZU5HAwB+ZgDtGYq3fgAAAABJRU5ErkJggg==)
        }

        ::-webkit-scrollbar-button:horizontal:increment:hover {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEWdtMT///8YSU3FAAAAAnRSTlP/AOW3MEoAAAAgSURBVHgBY2BEA+QLMGAIMGAIMGAIMBAUIGQoZU5HAwB+ZgDtGYq3fgAAAABJRU5ErkJggg==)
        }

        ::-webkit-scrollbar-button:horizontal:decrement {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEXM09b///8OmaLeAAAAAnRSTlP/AOW3MEoAAAAiSURBVHgBY2BEAxQJMKAJMKAJMKAJMOATgIkQMBTBooZfAH56AO2yINTrAAAAAElFTkSuQmCC)
        }

        ::-webkit-scrollbar-button:horizontal:decrement:hover {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEWdtMT///8YSU3FAAAAAnRSTlP/AOW3MEoAAAAiSURBVHgBY2BEAxQJMKAJMKAJMKAJMOATgIkQMBTBooZfAH56AO2yINTrAAAAAElFTkSuQmCC)
        }

        ::-webkit-scrollbar-button:vertical:increment {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEXM09b///8OmaLeAAAAAnRSTlP/AOW3MEoAAAAfSURBVHgBY2BEA7QTYIAChAoYH6EFxkeYwQBj0MelAH3GAO2C9+AaAAAAAElFTkSuQmCC)
        }

        ::-webkit-scrollbar-button:vertical:increment:hover {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEWdtMT///8YSU3FAAAAAnRSTlP/AOW3MEoAAAAfSURBVHgBY2BEA7QTYIAChAoYH6EFxkeYwQBj0MelAH3GAO2C9+AaAAAAAElFTkSuQmCC)
        }

        ::-webkit-scrollbar-button:vertical:decrement {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEXM09b///8OmaLeAAAAAnRSTlP/AOW3MEoAAAAgSURBVHgBY2BEAzQVYIAzYHwGGAvOZ4AyIXyECH1cCgB/GgDtpWTgqAAAAABJRU5ErkJggg==)
        }

        ::-webkit-scrollbar-button:vertical:decrement:hover {
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABlBMVEWdtMT///8YSU3FAAAAAnRSTlP/AOW3MEoAAAAgSURBVHgBY2BEAzQVYIAzYHwGGAvOZ4AyIXyECH1cCgB/GgDtpWTgqAAAAABJRU5ErkJggg==)
        }
        html,
        body {
            margin: 0;
            padding: 0;
        }
        [v-cloak] {
            opacity: 0 !important;
        }

        .el-image__error,
        .el-image__inner,
        .el-image__placeholder {
            background: #d1d1d1;
        }
        .pictureView>video{
           display: block;
           background-color: #000;
        }
        .playPause{
            display: inline-block;
            margin-right:10px;
            cursor: pointer;
        }
        .playPause>i{
            font-size: 20px;
        }
        .pictureView{
            width: 100%;
            height: 100%;
        }
        .pictureView video{
            width: 100%;
            height: 100%;
            display: block;
        }
        .el-card{
            margin: 20px 10px;
        }
        .el-card .processing{
            display: none;
        }
        .current{
            background-color: #c1dfff;
        }
        .current .processing{
            display: block;
            color: #f56c6c;
            font-weight: bold;
        }
        .el-card__body{
            position: relative;
        }
        .pictureView{
            position: relative;
        }
        .pictureView .record{
            position: absolute;
            top: 0;
            left: 0;
            background: #ff3d3d;
            color: #fff;
            font-size: 13px;
            padding: 5px 10px;
            transition: 0.3s;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .processingImg{
            margin:20px 10px;
        }
        .processingImg .el-image{
            width: 400px;
        }
        .processingImg .processingImg-text{
            margin:5px 0;
            color: #494949;
            font-weight: bold;
        }
        .collectionComplete .card{
            text-align: center;
        }
        .collectionComplete .card h4{
            font-size: 20px;
            margin: 10px 4px;
        }
        .collectionComplete .card p{
            font-size: 15px;
            font-weight: bold;
            margin: 10px 4px;
        }
        .collectionComplete .card .el-image,
        .collectionComplete .card video{
            width:100%;
            display: block;
            margin-bottom:5px;
        }
        .config{
            position: fixed;
            bottom:0;
            left: 50%;
            transform: translateX(-50%);
            background: #F56C6C;
            font-size: 13px;
            color: #fff;
            border-radius: 5px 5px 0 0;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .config:hover{
            opacity: 0.8;
        }
        .pictureView-video{
            position: relative;
            overflow: hidden;
        }
        .scanningLine{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-top: 4px solid #3fefef;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            opacity:0.8;
            /* animation: animate_line 3s linear infinite; */
            animation: animate_line 3s ease-in-out infinite;
        };

        @-webkit-keyframes animate_line {
            0%, 100% {
                transform: translateY(-5px);
            }
            50% {
                transform: translateY(100%);
            }
        }

        @keyframes animate_line {
            0%, 100% {
                transform: translateY(-5px);
            }
            50% {
                transform: translateY(100%);
            }
        }
    </style>
</head>

<body onbeforeunload="return false">
    <!-- chrome://flags/#unsafely-treat-insecure-origin-as-secure
    åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥éœ€è¦è®¿é—®çš„åœ°å€ï¼Œå¤šä¸ªåœ°å€ä½¿ç”¨â€œ,â€éš”å¼€ï¼Œç„¶åç‚¹å‡»å³ä¸‹è§’å¼¹å‡ºçš„RelaunchæŒ‰é’®ï¼Œè‡ªåŠ¨é‡å¯æµè§ˆå™¨ä¹‹åå°±å¯ä»¥åœ¨æ·»åŠ çš„httpåœ°å€ä¸‹è°ƒç”¨æ‘„åƒå¤´å’Œéº¦å…‹é£äº†ã€‚ -->

    <div id="app" class="app" v-cloak>
        <el-row>
            <el-col :span="8">
                <el-card :shadow="schedule==1?'always':'never'" :class="{'current':schedule==1}">
                    <div slot="header" class="clearfix">
                      <span>å¼€å§‹é‡‡é›†æ‘„åƒå¤´</span>
                      <el-button class="processing" style="float: right; padding: 3px 0" type="text">è¿›è¡Œä¸­</el-button>
                    </div>
                    <video-monitor @ready="monitorReady" ref="startMonitor" picturetype="å¼€å§‹" :qrcode="true" @result="startQrCodeResult"></video-monitor>
                  </el-card>
            </el-col>
            <el-col :span="8">
                <el-card :shadow="processing&&(schedule==2||schedule==3)?'always':'never'" :class="{'current':processing&&(schedule==2||schedule==3)}">
                    <div slot="header" class="clearfix">
                      <span>è§†é¢‘å½•åˆ¶æ‘„åƒå¤´</span>
                      <el-button class="processing" style="float: right; padding: 3px 0" type="text">è¿›è¡Œä¸­</el-button>
                    </div>
                    <video-monitor @ready="monitorReady" ref="monitor" picturetype="è§†é¢‘" :record="true" @result="monitorResult"></video-monitor>
                  </el-card>
            </el-col>
            <el-col :span="8">
                <el-card :shadow="schedule==3?'always':'never'" :class="{'current':schedule==3}">
                    <div slot="header" class="clearfix">
                      <span>ç»“æŸé‡‡é›†æ‘„åƒå¤´</span>
                      <el-button v-if="viedoMinTimes>0" style="float: right; padding: 3px 0;color:#F56C6C" type="text">{{viedoMinTimes}}ç§’å¼€å§‹é‡‡é›†</el-button>
                      <el-button class="processing" style="float: right; padding: 3px 0" type="text">è¿›è¡Œä¸­</el-button>
                    </div>
                    <video-monitor @ready="monitorReady" ref="endMonitor" picturetype="ç»“æŸ" :qrcode="true" @result="endQrCodeResult"></video-monitor>
                  </el-card>
            </el-col>
        </el-row>
        <div>
            <el-card shadow="never">
                <div style="text-align: center;">
                    <el-button type="primary"  @click="start" :disabled="processing" :loading="butLoading" native-type="button">å¼€å§‹</el-button>
                    <transition name="el-zoom-in-top">
                        <div class="processingImg" v-if="!isObjEmpty(startQcode)">
                            <el-image :src="startQcode.url" :preview-src-list="[startQcode.url]" fit="contain"></el-image>
                            <div class="processingImg-text" v-text="'IDï¼š'+startQcode.id"></div>
                            <div class="processingImg-text" v-text="startQcode.time"></div>
                        </div>
                    </transition>
                </div>
            </el-card>
        </div>

        <el-dialog
            class="collectionComplete"
            :title="'é‡‡é›†å®Œæˆ['+startQcode.id+']'"
            :visible.sync="collectionCompleteVisible"
            top="5vh"
            :close-on-click-modal="false"
            :close-on-press-escape="false"
            :show-close="false"
            :destroy-on-close="true"
            center>
            <el-row>
                <el-col :span="8">
                    <div class="card">
                        <h4>å¼€å§‹é‡‡é›†ç…§ç‰‡</h4>
                        <el-image @click="closeAlert" :src="startQcode.url" :preview-src-list="[startQcode.url,eddQcode.url]" fit="contain"></el-image>
                        <p v-text="startQcode.time"></p>
                        <!-- <pre>{{startQcode}}</pre> -->
                    </div>
                </el-col>
                <el-col :span="8">
                    <div class="card">
                        <h4>å½•åˆ¶è§†é¢‘</h4>
                        <video @click="closeAlert" @play="closeAlert" :src="recordVideo.url"  controls="controls" ref="video" webkit-playsinline="true" playsinline="true"></video>
                        <p v-text="recordVideo.time"></p>
                        <!-- <pre>{{recordVideo}}</pre> -->
                    </div>
                </el-col>
                <el-col :span="8">
                    <div class="card">
                        <h4>ç»“æŸé‡‡é›†ç…§ç‰‡</h4>
                        <el-image @click="closeAlert" :src="eddQcode.url" :preview-src-list="[eddQcode.url,startQcode.url]" fit="contain"></el-image>
                        <p v-text="eddQcode.time"></p>
                        <!-- <pre>{{eddQcode}}</pre> -->
                    </div>
                </el-col>
            </el-row>
            <p>ç‚¹å‡»å›¾ç‰‡æˆ–è§†é¢‘å…³é—­å®šæ—¶å™¨</p>
            <br />
            <el-alert :title="completeTimes+' ç§’åè‡ªåŠ¨å¯åŠ¨ä¸‹ä¸€ä¸ª'" @close="closeAlert" type="success" close-text="å–æ¶ˆå®šæ—¶" center></el-alert>
            <br />
            <div slot="footer" class="dialog-footer">
                <el-button @click="clearAutoNext">å–æ¶ˆ</el-button>
                <el-button @click="startAutoNext" type="primary">ç›´æ¥å¯åŠ¨ä¸‹ä¸€ä¸ª</el-button>
            </div>
        </el-dialog>
        <div style="height:80px"></div>
        <div class="config" @click="configVisible=!configVisible">é…ç½®</div>
        <el-dialog
            class="configVisible"
            title="å‚æ•°é…ç½®"
            :visible.sync="configVisible"
            top="5vh"
            width="360px"
            center>
            <el-form :model="configForm" label-position="top" size="mini">
                <el-form-item label="è§†é¢‘æœ€å°é•¿åº¦ï¼ˆå•ä½ï¼šç§’ï¼‰">
                    <el-input-number v-model="configForm.viedoMinTime" :precision="0" :step="1" :min="1" :max="30*60"></el-input-number>
                </el-form-item>
                <el-form-item label="è¯†åˆ«äºŒç»´ç é¢‘ç‡ï¼ˆå•ä½ï¼šç§’ï¼‰">
                    <el-input-number v-model="configForm.qrcodeTime" :precision="1" :step="0.1" :min="0.2" :max="2"></el-input-number>
                </el-form-item>
                <el-form-item label="é‡‡é›†ç»“æœä»¥åå†æ¬¡å¯åŠ¨çš„æ—¶é—´é—´éš”ï¼ˆå•ä½ï¼šç§’ï¼‰">
                    <el-input-number v-model="configForm.completeTime" :precision="0" :step="1" :min="10" :max="5*60"></el-input-number>
                </el-form-item>
                <el-form-item label="è§†é¢‘çš„æ¯”ç‰¹ç‡(æ•°å€¼è¶Šå¤§è§†é¢‘è¶Šæ¸…æ™°)">
                    <el-input-number v-model="configForm.videoBitsPerSecond" :precision="1" :step="0.5" :min="1" :max="8"></el-input-number>
                </el-form-item>
                <el-form-item label="äºŒç»´ç å ç”»é¢æ¯”ä¾‹(å•ä½ï¼šåŠåˆ†æ¯” å½“äºŒç»´ç é¢ç§¯è¶…è¿‡è®¾ç½®å€¼æ—¶æ— æ³•ç»§ç»­)">
                    <el-input-number v-model="configForm.IdentifyTheScale" :precision="0" :step="5" :min="10" :max="100"></el-input-number>
                </el-form-item>
                <el-form-item label="è‡ªåŠ¨ä¸‹è½½">
                    <el-switch v-model="configForm.autoDownloadFile" active-value="open" inactive-value="close"></el-switch>
                </el-form-item>
                <el-form-item label="æ˜¾ç¤ºäºŒç»´ç è¾…åŠ©çº¿">
                    <el-switch v-model="configForm.showQrcodeLine" active-value="open" inactive-value="close"></el-switch>
                </el-form-item>
                <el-form-item label="å¼€å§‹å’Œç»“æŸé‡‡é›†æ˜¾ç¤ºæ°´å°">
                    <el-switch v-model="configForm.watermarkShow" active-value="open" inactive-value="close"></el-switch>
                </el-form-item>
                <el-form-item label="æ¸…é™¤æ‘„åƒå¤´è®°å½•">
                    <el-button @click="clearCameraLog" native-type="button" type="danger" size="small" round>æ¸…é™¤</el-button>
                </el-form-item>
            </el-form>
        </el-dialog>
    </div>
    <script>
        "use strict";
        new Vue({
            el: '#app',
            data: {
                query:getQuery(),
                readyNum:0,
                schedule:'', //è¿›åº¦
                resultList:[], //ç»“æœåˆ—è¡¨
                butLoading:true, //æŒ‰é’®åŠ è½½çŠ¶æ€
                processing:false,
                startQcode:{}, //å¼€å§‹é‡‡é›†äºŒç»´ç 
                recordVideo:{}, //å½•åˆ¶è§†é¢‘
                eddQcode:{}, //ç»“æŸé‡‡é›†äºŒç»´ç 
                collectionCompleteVisible:false, //é‡‡é›†å®Œæˆå¼¹çª—
                configVisible:false, //é…ç½®å¼¹çª—
                configForm:{
                    viedoMinTime:window.localStorage.getItem(`viedoMinTime`)||10, //è§†é¢‘æœ€å°é•¿åº¦
                    qrcodeTime:window.localStorage.getItem(`qrcodeTime`)||0.5, //è¯†åˆ«äºŒç»´ç é¢‘ç‡
                    completeTime:window.localStorage.getItem(`completeTime`)||30, //é‡‡é›†ç»“æœä»¥åå†æ¬¡å¯åŠ¨çš„æ—¶é—´é—´éš”
                    IdentifyTheScale:window.localStorage.getItem(`IdentifyTheScale`)||60, //äºŒç»´ç å ç”»é¢æ¯”ä¾‹
                    autoDownloadFile:window.localStorage.getItem(`autoDownloadFile`)||'open', //è‡ªåŠ¨ä¸‹è½½
                    showQrcodeLine:window.localStorage.getItem(`showQrcodeLine`)||'open', //è‡ªåŠ¨ä¸‹è½½
                    watermarkShow:window.localStorage.getItem(`watermarkShow`)||'close', //è‡ªåŠ¨ä¸‹è½½
                    videoBitsPerSecond:window.localStorage.getItem(`videoBitsPerSecond`)||2, //è§†é¢‘çš„æ¯”ç‰¹ç‡
                },
                viedoMinTimes:0, //è§†é¢‘æœ€å°é•¿åº¦è®¡æ—¶å™¨
                completeTimes:0, //é‡‡é›†ç»“æœä»¥åå†æ¬¡å¯åŠ¨çš„æ—¶é—´é—´éš”è®¡æ—¶å™¨
            },
            watch: {
                configForm: {
                    handler(val, oldVal) {
                        this.setItemConfigForm();
                    },
                    deep: true
                }
            },
            mounted() {
                this.initStats();
                this.prompt();
                this.setItemConfigForm();
            },
            methods: {
                initStats() {
                    const stats = new Stats();
                    // window['discernCount'] = stats.addPanel( new Stats.Panel( 'count', '#ff8', '#221' ) );
                    console.log(stats);
                    stats.showPanel(1); // 0: fps, 1: ms, 2: mb, 3+: custom
                    stats.domElement.style = `
                        position: fixed;
                        left: 0px;
                        cursor: pointer;
                        opacity: 0.9;
                        z-index: 20;
                        bottom: 0px;
                    `;
                    document.body.appendChild(stats.dom);
                    requestAnimationFrame(function loop() {
                        stats.update();
                        requestAnimationFrame(loop)
                    });
                },
                isObjEmpty(obj) {
                    return isObjEmpty(obj)
                },
                setItemConfigForm(){
                    window.localStorage.setItem(`viedoMinTime`, this.configForm.viedoMinTime);
                    window.localStorage.setItem(`qrcodeTime`, this.configForm.qrcodeTime);
                    window.localStorage.setItem(`completeTime`, this.configForm.completeTime);
                    window.localStorage.setItem(`IdentifyTheScale`, this.configForm.IdentifyTheScale);
                    window.localStorage.setItem(`autoDownloadFile`, this.configForm.autoDownloadFile);
                    window.localStorage.setItem(`showQrcodeLine`, this.configForm.showQrcodeLine);
                    window.localStorage.setItem(`watermarkShow`, this.configForm.watermarkShow);
                    window.localStorage.setItem(`videoBitsPerSecond`, this.configForm.videoBitsPerSecond);
                },
                clearCameraLog(){
                    window.localStorage.removeItem('å¼€å§‹_deviceId');
                    window.localStorage.removeItem('è§†é¢‘_deviceId');
                    window.localStorage.removeItem('ç»“æŸ_deviceId');
                    this.$alert('æ¸…é™¤æˆåŠŸ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        type: 'success ',
                        showClose: false,
                        center: true
                    }).then(() => {
                        document.querySelector("body").removeAttribute('onbeforeunload');//ç§»é™¤ç¦»å¼€é¡µé¢æç¤º
                        setTimeout(() => {
                            window.location.reload();
                        }, 100);
                    })
                },
                //fmt  YYYY-mm-dd HH:MM:SS
                dateFormat(fmt, date) {
                    return dateFormat(fmt, date)
                },
                //blod=>url
                toUrl(blob){
                     return window.URL && window.URL.createObjectURL(blob);
                },
                //é‡Šæ”¾å†…å­˜
                releaseUrl(url){
                    window.URL && window.URL.revokeObjectURL(url);
                },
                //ä¸‹è½½æ–‡ä»¶
                downloadFile(url,fileName){
                    if(window.localStorage.getItem(`autoDownloadFile`)==='open'){
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                    }
                },
                monitorReady(){
                    this.readyNum++;
                    if(this.readyNum===3){
                        this.butLoading = false;
                        const AutoNext = window.sessionStorage.getItem('AutoNext');
                        if(!this.isObjEmpty(AutoNext)){
                            window.sessionStorage.removeItem('AutoNext');
                            setTimeout(()=>{
                                speakText(`å¼€å§‹è¯†åˆ«`); //è¯­éŸ³æç¤º
                                this.start();
                            },500);
                        }
                    }
                },
                //å¼€å§‹ä»»åŠ¡
                start(){
                    const deviceId1 = this.$refs.startMonitor.deviceId;
                    const deviceId2 = this.$refs.monitor.deviceId;
                    const deviceId3 = this.$refs.endMonitor.deviceId;
                    if(this.isObjEmpty(deviceId1)){
                        this.$message.error('è¯·é€‰æ‹©é‡‡é›†æ‘„åƒå¤´');
                        return;
                    }else if(this.isObjEmpty(deviceId2)){
                        this.$message.error('è¯·é€‰æ‹©è§†é¢‘å½•åˆ¶æ‘„åƒå¤´');
                        return;
                    }else if(this.isObjEmpty(deviceId3)){
                        this.$message.error('è¯·é€‰æ‹©ç»“æŸé‡‡é›†æ‘„åƒå¤´');
                        return;
                    }else{
                        document.addEventListener('visibilitychange',_=>{
                            // ç”¨æˆ·æ¯å±ã€æˆ–è€…åˆ‡åˆ°åå°è¿è¡Œ ï¼ˆç¦»å¼€é¡µé¢ï¼‰
                            if (document.visibilityState === 'hidden') {
                                document.title = `ğŸš« å½•åˆ¶è§†é¢‘`;
                                if(this.processing){
                                    speakText(`è¯·å‹¿ç¦»å¼€ç”»é¢`); //è¯­éŸ³æç¤º
                                    sendNotify(`è­¦å‘Š`,`è¯·å‹¿ç¦»å¼€ç”»é¢ï¼å¯èƒ½ä¼šå¯¼è‡´å½•åˆ¶å¤±è´¥ï¼`); //å‘é€é€šçŸ¥
                                }
                            }
                            // ç”¨æˆ·æ‰“å¼€æˆ–å›åˆ°é¡µé¢
                            if (document.visibilityState === 'visible') {
                                document.title = `âœ”ï¸ å½•åˆ¶è§†é¢‘`;
                            };
                        });
                        if(!this.isObjEmpty(this.startQcode.url)){
                            this.releaseUrl(this.startQcode.url);
                        };
                        if(!this.isObjEmpty(this.recordVideo.url)){
                            this.releaseUrl(this.recordVideo.url);
                        };
                        if(!this.isObjEmpty(this.eddQcode.url)){
                            this.releaseUrl(this.eddQcode.url);
                        };
                        this.startQcode = {};
                        this.recordVideo = {};
                        this.eddQcode = {};

                        this.schedule = '1';
                        this.butLoading = false;
                        this.processing = true; //è¿›è¡Œä¸­
                        this.$refs.startMonitor.startDiscern(); //å¼€å§‹è¯†åˆ«äºŒç»´ç 
                        console.log('å¼€å§‹ä»»åŠ¡');
                    }
                },
                //ç»“æŸ
                end(){},
                //ç¬¬ä¸€ä¸ªæ‘„åƒå¤´äºŒç»´ç æ˜¯è¢«ç»“æœ
                async startQrCodeResult(obj){
                    console.log(`[é‡‡é›†å¼€å§‹]`,obj);
                    if(obj.blob && !this.isObjEmpty(obj.id)){
                        speakText(`è¯†åˆ«æˆåŠŸï¼å¼€å§‹å½•åˆ¶è§†é¢‘`); //è¯­éŸ³æç¤º
                        this.$notify({
                            title: 'è¯†åˆ«æˆåŠŸï¼',
                            message: 'å¼€å§‹å½•åˆ¶è§†é¢‘',
                            duration:2000,
                            type: 'success'
                        });
                        obj.time = new Date().toLocaleString();
                        obj.url = this.toUrl(obj.blob);
                        if(obj.picturetype=="å¼€å§‹"){
                            this.startQcode = obj;
                            var fileName = `${obj.id}_${this.dateFormat('YYYYmmddHHMMSS',new Date())}_${obj.picturetype || obj.type}.${obj.type=='viedo'?'webm':'png'}`;
                            this.downloadFile(obj.url,fileName);
                            obj.upurl  = await this.upload(obj.blob,fileName,obj.id);
                        };
                        this.schedule='2';
                        this.$refs.monitor.openMedia(true,obj.id); //å¼€å§‹å½•åƒ
                        //å¯åŠ¨ç¬¬ä¸‰ä¸ªæ‘„åƒå¤´è¯†åˆ«äºŒç»´ç 
                        var viedoMinTime = +(window.localStorage.getItem(`viedoMinTime`)||10);
                        this.viedoMinTimes = viedoMinTime;
                        if(window['viedoMinTimesTask']){
                            clearInterval(window['viedoMinTimesTask']);
                        };
                        window['viedoMinTimesTask'] = setInterval(()=>{
                            this.viedoMinTimes--;
                            if(this.viedoMinTimes<=0){
                                clearInterval(window['viedoMinTimesTask']);
                                window['viedoMinTimesTask'] = null;
                                this.schedule='3';
                                this.$refs.endMonitor.startDiscern(obj.id); //å¼€å§‹è¯†åˆ«äºŒç»´ç 
                            }
                        },1000);
                        // setTimeout(() => {
                        //     this.schedule='3';
                        //     this.$refs.endMonitor.startDiscern(obj.id); //å¼€å§‹è¯†åˆ«äºŒç»´ç 
                        // }, viedoMinTime*1000);
                    }else{
                        speakText(`å¼€å§‹é‡‡é›†äºŒç»´ç è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ï¼`); //è¯­éŸ³æç¤º
                        this.$notify.error({
                            title: 'é”™è¯¯',
                            message: `å¼€å§‹é‡‡é›†äºŒç»´ç è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ï¼`,
                            duration:0,
                        });
                    }
                },
                //ç»“æŸé‡‡é›†æ‘„åƒå¤´
                async endQrCodeResult(obj){
                    console.log(`[é‡‡é›†ç»“æŸ]`,obj);
                    if(obj.blob && !this.isObjEmpty(obj.id)){
                        speakText(`è¯†åˆ«æˆåŠŸ ç»“æŸå½•åˆ¶å¹¶ä¸Šä¼ `); //è¯­éŸ³æç¤º
                        this.$notify({
                            title: 'è¯†åˆ«æˆåŠŸï¼',
                            message: 'ç»“æŸå½•åˆ¶è§†é¢‘å¹¶ä¸Šä¼ ',
                            duration:2000,
                            type: 'success'
                        });
                        obj.time = new Date().toLocaleString();
                        obj.url = this.toUrl(obj.blob);
                        if(obj.picturetype=="ç»“æŸ"){
                            this.eddQcode = obj;
                            var fileName = `${obj.id}_${this.dateFormat('YYYYmmddHHMMSS',new Date())}_${obj.picturetype || obj.type}.${obj.type=='viedo'?'webm':'png'}`;
                            this.downloadFile(obj.url,fileName);
                            obj.upurl  = await this.upload(obj.blob,fileName,obj.id);
                        };
                        this.$refs.monitor.endRecord(); //åœæ­¢å½•åƒ
                    }else{
                        speakText(`ç»“æŸé‡‡é›†äºŒç»´ç è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ï¼`); //è¯­éŸ³æç¤º
                        this.$notify.error({
                            title: 'é”™è¯¯',
                            duration:0,
                            message: `ç»“æŸé‡‡é›†äºŒç»´ç è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•ï¼`,
                        });
                    }
                },
                //è§†é¢‘
                async monitorResult(obj){
                    this.processing = false; //è¿›è¡Œä¸­
                    console.log(`[ä¿å­˜è§†é¢‘]`,obj);
                    obj.time = new Date().toLocaleString();
                    obj.url = this.toUrl(obj.blob);
                    this.recordVideo = obj;
                    var fileName = `${obj.id}_${this.dateFormat('YYYYmmddHHMMSS',new Date())}_${obj.picturetype || obj.type}.${obj.type=='viedo'?'webm':'png'}`;
                    this.downloadFile(obj.url,fileName);
                    obj.upurl  = await this.upload(obj.blob,fileName,obj.id);
                    this.uploadData();
                },
                async uploadData(){
                    this.schedule='';
                    const startQcode = this.startQcode;//å¼€å§‹é‡‡é›†äºŒç»´ç 
                    const recordVideo = this.recordVideo;//å½•åˆ¶è§†é¢‘
                    const eddQcode = this.eddQcode;//ç»“æŸé‡‡é›†äºŒç»´ç 
                    if(this.isObjEmpty(startQcode.upurl)||this.isObjEmpty(recordVideo.upurl)||this.isObjEmpty(eddQcode.upurl)){
                        speakText(`ä¸Šä¼ å¤±è´¥ï¼è¯·ç¨åå†è¯•ï¼`); //è¯­éŸ³æç¤º
                        this.$notify.error({
                            title: 'é”™è¯¯',
                            duration:0,
                            message: `ä¸Šä¼ å¤±è´¥ï¼è¯·ç¨åå†è¯•ï¼`,
                        });
                    }else{
                        console.log(`uploadData[å¼€å§‹é‡‡é›†äºŒç»´ç ]`,startQcode.id,startQcode.upurl);
                        console.log(`uploadData[å½•åˆ¶è§†é¢‘]`,recordVideo.id,recordVideo.upurl);
                        console.log(`uploadData[ç»“æŸé‡‡é›†äºŒç»´ç ]`,eddQcode.id,eddQcode.upurl);
                        this.collectionCompleteVisible = true;
                        this.autoNext();
                        setTimeout(() => {
                            speakText(`ä¸Šä¼ æˆåŠŸ`); //è¯­éŸ³æç¤º
                        }, 3000);
                    };
                },
                autoNext(){
                    var completeTime = +(window.localStorage.getItem(`completeTime`)||30);
                    this.completeTimes = completeTime;
                    if(window['completeTimeTask']){
                        clearInterval(window['completeTimeTask']);
                    };
                    window['completeTimeTask'] = setInterval(()=>{
                        this.completeTimes--;
                        if(this.completeTimes<=0){
                            clearInterval(window['completeTimeTask']);
                            window['completeTimeTask'] = null;
                            this.goNext();
                        }
                    },1000);
                },
                closeAlert(){
                    if(window['completeTimeTask']){
                        clearInterval(window['completeTimeTask']);
                    };
                },
                clearAutoNext(){
                    if(window['completeTimeTask']){
                        clearInterval(window['completeTimeTask']);
                    };
                    this.completeTimes = 0;
                    this.collectionCompleteVisible = false;
                },
                startAutoNext(){
                    this.clearAutoNext();
                    this.goNext();
                },
                goNext(){
                    if(!this.isObjEmpty(this.startQcode.url)){
                        this.releaseUrl(this.startQcode.url);
                    };
                    if(!this.isObjEmpty(this.recordVideo.url)){
                        this.releaseUrl(this.recordVideo.url);
                    };
                    if(!this.isObjEmpty(this.eddQcode.url)){
                        this.releaseUrl(this.eddQcode.url);
                    };
                    window.sessionStorage.setItem('AutoNext',new Date());
                    const count = +(this.query.count||0);
                    document.querySelector("body").removeAttribute('onbeforeunload');//ç§»é™¤ç¦»å¼€é¡µé¢æç¤º
                    setTimeout(()=>{
                        window.location.replace(`index.html?count=${count+1}&t=${this.dateFormat('mmddHHMMSS',new Date())}`);
                    },100);
                },
                upload(fileBlob, fileName,qrcode) {
                    return new Promise((resolve, reject)=>{
                        const loading = this.$loading({
                            lock: true,
                            text: 'ä¸Šæ¬¡æ–‡ä»¶ä¸­...',
                            spinner: 'el-icon-loading',
                            background: 'rgba(0, 0, 0, 0.7)'
                        });
                        const formData = new FormData()
                        var fileOfBlob = new File([fileBlob], fileName);
                            formData.append("file", fileOfBlob);
                            formData.append("folder", qrcode);
                            this.$http.post('http://192.168.3.16:7777/upload', formData, {
                                headers: {
                                    "Content-Type": "multipart/form-data"
                                }
                            }).then(xml => {
                                this.loading = false;
                                const res = xml.body;
                                if (res.code == 200) {
                                    resolve(res.file)
                                }
                            }).catch(err => {
                                this.$notify.error({
                                    title: 'é”™è¯¯',
                                    duration:0,
                                    message: `ä¸Šä¼ å¤±è´¥ï¼è¯·ç¨åå†è¯•ï¼${fileName}`,
                                });
                            }).finally(_=>{
                                loading.close();
                            })
                    })
                },
                prompt(){
                    const isHaveread = this.query.count;
                    if(this.isObjEmpty(isHaveread)){
                        const html = `
                            <ol>
                                <li>è¯·ä½¿ç”¨<b>è°·æ­Œï¼ˆGoogle Chromeï¼‰æµè§ˆå™¨</b>ã€‚</li>
                                <li>è¿›å…¥ç½‘é¡µåæ‰“å¼€<b>æ‘„åƒå¤´ã€è‡ªåŠ¨ä¸‹è½½é¡¹ã€é€šçŸ¥</b>æƒé™ã€‚</li>
                                <li>æ‰“å¼€æµè§ˆå™¨è®¾ç½®ï¼Œè¿›å»<b>ä¸‹è½½å†…å®¹</b>åŠŸèƒ½ï¼Œè®¾ç½®ä¸‹è½½çš„ä½ç½®ï¼Œå…³é—­<b>ä¸‹è½½å‰è¯¢é—®æ¯ä¸ªæ–‡ä»¶çš„ä¿å­˜ä½ç½®</b>ã€‚</li>
                                <li>ä½¿ç”¨æ­¤ç³»ç»Ÿæ—¶ï¼Œè¯·å…³é—­å…¶å®ƒè½¯ä»¶ã€‚</li>
                                <li>è‡ªåŠ¨ä¸‹è½½çš„æ–‡ä»¶åè§„åˆ™ <b>ï¼ˆID_æ—¶é—´.ç±»å‹ï¼‰å¦‚é‡åˆ°ä¸Šä¼ å¤±è´¥å¯å°†æ­¤æ–‡ä»¶å‘é€ç»™åå°ç®¡ç†äººå‘˜ã€‚</b></li>
                                <li style="color:#F56C6C">ä¸€ä¸ªé•œå¤´ä¸­ç¦æ­¢å‡ºç°å¤šä¸ªäºŒç»´ç ã€‚</li>
                                <li style="color:#F56C6C">åœ¨è¯†åˆ«äºŒç»´ç å’Œå½•åƒä¸­åˆ‡å‹¿<b>å…³é—­ã€åˆ·æ–°ã€éšè—</b>æ­¤é¡µé¢ã€‚</li>
                            </ol>
                        `;
                        this.$confirm(html, 'æ³¨æ„äº‹é¡¹', {
                            confirmButtonText: 'æˆ‘çŸ¥é“äº†',
                            cancelButtonText: 'å–æ¶ˆ',
                            dangerouslyUseHTMLString: true
                        }).then(() => {

                        }).catch(() => {

                        });
                    };
                },
            }
        });
    </script>
</body>

</html>